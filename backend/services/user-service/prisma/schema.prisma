// Prisma schema for User Service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum OAuthProvider {
  GOOGLE
  APPLE
  FACEBOOK
}

enum NotificationPreference {
  EMAIL
  PUSH
  SMS
  ALL
  NONE
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     Boolean   @default(false)
  emailVerifiedAt   DateTime?
  password          String?
  firstName         String?
  lastName          String?
  phone             String?   @unique
  phoneVerified     Boolean   @default(false)
  avatar            String?
  role              UserRole  @default(USER)
  isActive          Boolean   @default(true)
  isBlocked         Boolean   @default(false)
  blockedReason     String?
  blockedAt         DateTime?
  lastLoginAt       DateTime?
  lastLoginIp       String?
  loginAttempts     Int       @default(0)
  lockedUntil       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  oauthAccounts     OAuthAccount[]
  sessions          Session[]
  verificationTokens VerificationToken[]
  passwordResets    PasswordReset[]
  preferences       UserPreference?
  addresses         Address[]
  cashbackAccount   CashbackAccount?
  favorites         Favorite[]
  priceAlerts       PriceAlert[]
  reviews           Review[]

  @@index([email])
  @@index([phone])
  @@map("users")
}

model OAuthAccount {
  id           String        @id @default(cuid())
  userId       String
  provider     OAuthProvider
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  scope        String?
  tokenType    String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("oauth_accounts")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  userAgent    String?
  ip           String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model VerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  type      String   // EMAIL, PHONE
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("verification_tokens")
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_resets")
}

model UserPreference {
  id                      String                 @id @default(cuid())
  userId                  String                 @unique
  language                String                 @default("tr")
  currency                String                 @default("TRY")
  timezone                String                 @default("Europe/Istanbul")
  notifications           NotificationPreference @default(ALL)
  emailNotifications      Boolean                @default(true)
  pushNotifications       Boolean                @default(true)
  smsNotifications        Boolean                @default(false)
  priceDropAlerts         Boolean                @default(true)
  weeklyDigest            Boolean                @default(true)
  marketingEmails         Boolean                @default(false)
  theme                   String                 @default("light")
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  title        String   // Home, Work, etc.
  firstName    String
  lastName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String   @default("TR")
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("addresses")
}

model CashbackAccount {
  id                String   @id @default(cuid())
  userId            String   @unique
  balance           Decimal  @default(0) @db.Decimal(10, 2)
  totalEarned       Decimal  @default(0) @db.Decimal(10, 2)
  totalWithdrawn    Decimal  @default(0) @db.Decimal(10, 2)
  pendingBalance    Decimal  @default(0) @db.Decimal(10, 2)
  tier              String   @default("bronze") // bronze, silver, gold, platinum
  bonusMultiplier   Decimal  @default(1.0) @db.Decimal(3, 2)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("cashback_accounts")
}

model Favorite {
  id         String   @id @default(cuid())
  userId     String
  productId  String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@map("favorites")
}

model PriceAlert {
  id           String   @id @default(cuid())
  userId       String
  productId    String
  targetPrice  Decimal  @db.Decimal(10, 2)
  isActive     Boolean  @default(true)
  triggeredAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@map("price_alerts")
}

model Review {
  id          String   @id @default(cuid())
  userId      String
  productId   String
  rating      Int      // 1-5
  title       String?
  comment     String?
  isVerified  Boolean  @default(false) // Verified purchase
  helpfulCount Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId])
  @@map("reviews")
}
